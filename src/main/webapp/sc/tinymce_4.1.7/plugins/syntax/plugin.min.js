tinymce.PluginManager.add('syntax', function(editor) {

	$('#content_ifr').ready(function() {
		//window.onmousewheel=function(){return false;};
	});

	String.prototype.replaceAll = function(reallyDo, replaceWith, ignoreCase) {
	    if (!RegExp.prototype.isPrototypeOf(reallyDo)) {
	        return this.replace(new RegExp(reallyDo, (ignoreCase ? "gi": "g")), replaceWith);
	    } else {
	        return this.replace(reallyDo, replaceWith);
	    };
	};

	function focus_control(editor, code) {
    	var cc = editor.selection.getEnd();
    	if (!/\S/.test(cc.innerHTML.replaceAll('&nbsp;','')) && cc.tagName != 'PRE' && cc.tagName != 'BR') {
    		editor.selection.select(cc);
    	}
    	if ($(cc).last().nextAll().length <= 1) {
    		editor.insertContent(code+'<p>&nbsp;</p>');
    	} else {
    		editor.insertContent(code, cc);
    	}
	}

    // Add a button that opens a window
    editor.addButton('syntax', {
        type: 'splitbutton',
        icon: 'syntax',
        tooltip: 'Syntax',
        onclick: function() {
        	this.showMenu();
        },
        menu: [
            {text: 'Java', onclick: function() {
            	focus_control(editor, '<pre class="brush:java;"></pre>');
            }},
            {text: 'C/C++/Objective-C', onclick: function() {
            	focus_control(editor, '<pre class="brush:cpp;"></pre>');
            }},
            {text: 'C#', onclick: function() {
            	focus_control(editor, '<pre class="brush:c#;"></pre>');
            }},
            {text: 'JavaScript', onclick: function() {
            	focus_control(editor, '<pre class="brush:js;"></pre>');
            }},
            {text: 'PHP', onclick: function() {
            	focus_control(editor, '<pre class="brush:php;"></pre>');
            }},
            {text: 'Perl', onclick: function() {
            	focus_control(editor, '<pre class="brush:perl;"></pre>');
            }},
            {text: 'Python', onclick: function() {
            	focus_control(editor, '<pre class="brush:python;"></pre>');
            }},
            {text: 'Ruby', onclick: function() {
            	focus_control(editor, '<pre class="brush:ruby;"></pre>');
            }},
            {text: 'HTML', onclick: function() {
            	focus_control(editor, '<pre class="brush:html;"></pre>');
            }},
            {text: 'XML', onclick: function() {
            	focus_control(editor, '<pre class="brush:xml;"></pre>');
            }},
            {text: 'CSS', onclick: function() {
            	focus_control(editor, '<pre class="brush:css;"></pre>');
            }},
            {text: 'ASP/Basic', onclick: function() {
            	focus_control(editor, '<pre class="brush:vb;"></pre>');
            }},
            {text: 'Delphi/Pascal', onclick: function() {
            	focus_control(editor, '<pre class="brush:pascal;"></pre>');
            }},
            {text: 'Scala', onclick: function() {
            	focus_control(editor, '<pre class="brush:scala;"></pre>');
            }},
            {text: 'Groovy', onclick: function() {
            	focus_control(editor, '<pre class="brush:groovy;"></pre>');
            }},
            {text: 'Lua', onclick: function() {
            	focus_control(editor, '<pre class="brush:lua;"></pre>');
            }},
            {text: 'SQL', onclick: function() {
            	focus_control(editor, '<pre class="brush:sql;"></pre>');
            }},
            {text: 'Google Go', onclick: function() {
            	focus_control(editor, '<pre class="brush:cpp;"></pre>');
            }},
            {text: 'Flash/ActionScript/Flex', onclick: function() {
            	focus_control(editor, '<pre class="brush:as3;"></pre>');
            }},
            {text: 'WPF/SliverLight', onclick: function() {
            	focus_control(editor, '<pre class="brush:xml;"></pre>');
            }},
            {text: 'Shell/批处理', onclick: function() {
            	focus_control(editor, '<pre class="brush:shell;"></pre>');
            }}
        ]
	});
});
